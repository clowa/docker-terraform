---
kind: pipeline
type: kubernetes
name: docker build

platform:
  os: linux

trigger:
  branch:
    - master

volumes:
  - name: docker
    host:
      path: /var/tmp/docker
  - name: docker-ca
    temp: {}
  - name: docker-client
    temp: {}

services:
  - name: docker
    image: docker:dind
    privileged: true
    environment:
      DOCKER_TLS_CERTDIR: /certs
    resources:
      requests:
        cpu: 1
        memory: 512Mi
      limits:
        memory: 1Gi
    ports:
      - 2376
    volumes:
      - name: docker
        path: /var/lib/docker
      - name: docker-ca
        path: /certs/ca
      - name: docker-client
        path: /certs/client

steps:
  - name: docker-healthcheck
    image: docker:latest
    volumes:
      - name: docker-client
        path: /certs/client
    environment:
      DOCKER_HOST: "tcp://127.0.0.1:2376"
      DOCKER_TLS_CERTDIR: /certs
    commands:
      - |
        while ! docker info > /dev/null 2>&1; do
          echo "Docker does not seem to be running. Retry in 5 seconds"
          sleep 5
        done
      - docker version

  - name: docker-build
    image: crazymax/docker
    privileged: true
    volumes:
      - name: docker-client
        path: /certs/client
    environment:
      DOCKER_HOST: "tcp://127.0.0.1:2376"
      DOCKER_TLS_CERTDIR: /certs
      DOCKER_HUB_USERNAME:
        from_secret: docker_hub_username
      DOCKER_HUB_PASSWORD:
        from_secret: docker_hub_password
    commands:
      - apk add --quiet --no-cache --upgrade jq curl
      - echo "$DOCKER_HUB_PASSWORD" | docker login --username "$DOCKER_HUB_USERNAME" --password-stdin
      - ./build.sh -l || exit 1

  - name: notification
    image: appleboy/drone-telegram
    settings:
      to:
        from_secret: telegram_user_id
      token:
        from_secret: telegram_api_token
      format: markdown
      message: >
        {{#success build.status}}
        ✅ Image build #{{build.number}} of `{{repo.name}}` succeeded.

        ⏱ Took: {{since build.started}}

        🌐 {{ build.link }}
        {{else}}
        ❌ Image build #{{build.number}} of `{{repo.name}}` failed.

        ⏱ Took: {{since build.started}}

        🌐 {{ build.link }}
        {{/success}}
    when:
      status: [success, failure]

---
kind: secret
name: docker_hub_username
get:
  path: docker-hub
  name: username

---
kind: secret
name: docker_hub_password
get:
  path: docker-hub
  name: password

---
kind: secret
name: telegram_user_id
get:
  path: drone-pipeline-telegram-secret
  name: telegram-chatID

---
kind: secret
name: telegram_api_token
get:
  path: drone-pipeline-telegram-secret
  name: telegram-token
